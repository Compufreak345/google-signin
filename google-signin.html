<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-icon/core-icon.html">
<link rel="import" href="../core-icons/core-icons.html">
<link rel="import" href="../core-signals/core-signals.html">
<link rel="import" href="../font-roboto/roboto.html">
<link rel="import" href="../google-apis/google-js-api.html">
<link rel="import" href="../paper-ripple/paper-ripple.html">
<link rel="import" href="../paper-shadow/paper-shadow.html">
<link rel="import" href="google-icons.html">

<!--
Copyright (c) 2014 Google Inc. All rights reserved.

LICENSE: github.com/GoogleWebComponents/google-signin/blob/master/LICENSE
AUTHOR(s): Addy Osmani, Gerwin Sturm, Rob Dodson, and Randy Merrill.
-->

<!--
&lt;google-signin&gt; is used to authenticate with Google, allowing you to interact
with other Google APIs such as Drive and Google+.

<img style="max-width:100%;" src="https://cloud.githubusercontent.com/assets/107076/6791176/5c868822-d16a-11e4-918c-ec9b84a2db45.png"/>

#### Examples

    <google-signin clientId="..." scopes="https://www.googleapis.com/auth/drive"></google-signin>

    <google-signin labelSignin="Sign-in" clientId="..." scopes="https://www.googleapis.com/auth/drive"></google-signin>

    <google-signin theme="dark" width="iconOnly" clientId="..." scopes="https://www.googleapis.com/auth/drive"></google-signin>

#### Notes

The attribute `clientId` is provided in your Google Developers Console
(https://console.developers.google.com).

The `scopes` attribute allows you to specify which scope permissions are required
(e.g do you want to allow interaction with the Google Drive API). Many APIs also
need to be enabled in the Google Developers Console before you can use them.
The `requestVisibleActions` attribute is necessary if you want to write app
activities (https://developers.google.com/+/web/app-activities/) on behalf of
the user. Please note that this attribute is only valid in combination with the
plus.login scope (https://www.googleapis.com/auth/plus.login).

The `labelSignin` attribute is an optional piece of text used for customizing
the label on the sign-in button. `labelSignout` allows you to customize the label
for sign-out, and `labelAdditional` defines the label that is displayed when
additional permissions are necessary for incremental auth.

The button can be styled in using the `height`, `width`, and `theme` attributes.
These attributes help you follow the Google+ Sign-In button branding guidelines
(https://developers.google.com/+/branding-guidelines).

The `google-signin-success` event is triggered when a user successfully authenticates
and `google-signin-failure` is triggered when this is not the case. Both events
will also provide the data returned by the Google client authentication process.

Additional events, such as `google-signout-attempted` and `google-signed-out` are
triggered when the user attempts to sign-out and successfully signs out.

The `google-signin-necessary` event is fired when scopes requested via
google-signin-aware elements require additional user permissions.

#### Testing

By default, the demo accompanying this element is setup to work on localhost with
port 8080. That said, you *should* update the `clientId` to your own one for
any apps you're building. See the Google Developers Console
(https://console.developers.google.com) for more info.

@class google-signin
@blurb A Polymer element for authenticating and authorizing with Google Services.
@status beta
@homepage http://googlewebcomponents.github.io/google-signin
-->

<dom-module id="google-signin">
  <link rel="import" type="css" href="google-signin.css">
  <template>
    <google-js-api on-js-api-load="loadAuth"></google-js-api>

    <core-signals 
      on-core-signal-google-auth-request="authRequestScopes"
      on-core-signal-google-auth-user="authUserChange"
      on-core-signal-google-auth-scopes="authScopesChange"
    ></core-signals>

    <template if="{{raised}}">
      <paper-shadow id="shadow" fit animated></paper-shadow>
    </template>

    <div id="button" 
      class$="[[computeButtonClass(height, width, theme, signedIn, brand, additionalAuth)]]">

      <paper-ripple id="ripple" fit></paper-ripple>
      <!-- this div is needed to position the ripple behind text content -->
      <div relative layout horizontal center-center>
        <template is="x-if" if="{{computeButtonIsSignIn(signedIn, additionalAuth)}}">
          <div class="button-content signIn" tabindex="0"
              on-click="signIn" on-keydown="signInKeyPress">
            <span class="icon"><core-icon icon="[[computeIcon(brand)]]"></core-icon></span>
            <span class="buttonText">{{labelSignin}}</span>
          </div>
        </template>
        <template is="x-if" if="{{ computeButtonIsSignOut(signedIn, additionalAuth) }}">
          <div class="button-content signOut" tabindex="0"
              on-click="signOut" on-keydown="signOutKeyPress">
            <span class="icon"><core-icon icon="[[computeIcon(brand)]]"></core-icon></span>
            <span class="buttonText">{{labelSignout}}</span>
          </div>
        </template>
        <template is="x-if" if="{{ computeButtonIsSignOutAddl(signedIn, additionalAuth) }}">
          <div class="button-content signIn" tabindex="0"
              on-click="signIn" on-keydown="signInKeyPress">
            <span class="icon"><core-icon icon="[[computeIcon(brand)]]"></core-icon></span>
            <span class="buttonText">{{labelAdditional}}</span>
          </div>
        </template>
      </div>
    </div>
  </template>
</dom-module>
<script>
  (function() {

    var authorizedScopes = [];
    var extraScopes = [];
    var defaultHandler = null;

    /**
     * Enum brand values.
     * @readonly
     * @enum {string}
     */
    var BrandValue = {
        GOOGLE: 'google',
        PLUS: 'google-plus'
    };

    /**
     * Enum height values.
     * @readonly
     * @enum {string}
     */
    var HeightValue = {
      SHORT: 'short',
      STANDARD: 'standard',
      TALL: 'tall'
    };

    /**
     * Enum button label default values.
     * @readonly
     * @enum {string}
     */
    var LabelValue = {
      STANDARD: 'Sign in',
      WIDE: 'Sign in with Google',
      WIDE_PLUS: 'Sign in with Google+'
    };

    /**
     * Enum of attributes to be passed through to the login API call.
     * @readonly
     * @enum {string}
     */
    var ProxyLoginAttributes = {
      'appPackageName': 'apppackagename',
      'clientId': 'clientid',
      'cookiePolicy': 'cookiepolicy',
      'requestVisibleActions': 'requestvisibleactions'
    };

    /**
     * Enum theme values.
     * @readonly
     * @enum {string}
     */
    var ThemeValue = {
      LIGHT: 'light',
      DARK: 'dark'
    };

    /**
     * Enum width values.
     * @readonly
     * @enum {string}
     */
    var WidthValue = {
      ICON_ONLY: 'iconOnly',
      STANDARD: 'standard',
      WIDE: 'wide'
    };

    /**
     * Adds any ungranted, unique scopes to the provided authScopes.
     *
     * @param {String} authScopes Scopes being requested.
     */
    var mergeExtraScopes = function(authScopes) {
      if (!extraScopes.length) {
        return authScopes;
      }

      var scopes = authScopes.split(' ');

      // Check if there are any unauthorized scopes to add to the scope list.
      for (var i = 0; i < extraScopes.length; i++) {
        var currentScope = extraScopes[i].toLowerCase();
        if (authorizedScopes.indexOf(currentScope) < 0
            && scopes.indexOf(currentScope) < 0) {
          scopes.push(currentScope);
        }
      }

      return scopes.join(' ');
    };

    /**
     * Called when authorization server replies.
     *
     * @param {Object} result Authorization result.
     * @event google-signin-success
     */

    /**
     * Called when the user is signed-out.
     *
     * @param {Object} result Authorization result.
     * @event google-signed-out
     */

    Polymer({

      is: 'google-signin',

      properties: {
        /**
         * App package name for android over-the-air installs.
         * See the relevant [docs](https://developers.google.com/+/web/signin/android-app-installs)
         *
         * @attribute appPackageName
         * @type string
         * @default ''
         */
        appPackageName: {
          type: String,
          value: ''
        },

        /**
         * The brand being used for logo and styling.
         *
         * @default google
         * @type string
         */
        brand: {
          type: String,
          value: 'google'
        },

        /**
         * a Google Developers clientId reference
         *
         * @attribute clientId
         * @type string
         */
        clientId: {
          type: String,
          value: ''
        },

        /**
         * The cookie policy defines what URIs have access to the session cookie
         * remembering the user's sign-in state.
         * See the relevant [docs](https://developers.google.com/+/web/signin/reference#determining_a_value_for_cookie_policy) for more information.
         *
         * @attribute cookiePolicy
         * @type string
         * @default 'single_host_origin'
         */
        cookiePolicy: {
          type: String,
          value: 'single_host_origin'
        },

        /**
         * The height to use for the button.
         *
         * Available options: short, standard, tall.
         *
         * @attribute height
         * @type {HeightValue}
         * @default 'standard'
         */
        height: {
          type: String,
          value: 'standard'
        },

        /**
         * By default the ripple expands to fill the button. Set this to true to
         * constrain the ripple to a circle within the button.
         *
         * @attribute fill
         * @type boolean
         * @default true
         */
        fill: {
          type: Boolean,
          value: true
        },

        /**
         * An optional label for the button for additional permissions.
         *
         * @attribute labelAdditional
         * @type string
         * @default 'Additional permissions required'
         */
        labelAdditional: {
          type: String,
          value: 'Additional permissions required'
        },

        /**
         * An optional label for the sign-in button.
         *
         * @attribute labelSignin
         * @type string
         */
        labelSignin: {
          type: String,
          value: 'Sign in'
        },

        /**
         * An optional label for the sign-out button.
         *
         * @attribute labelSignout
         * @type string
         * @default 'Sign out'
         */
        labelSignout: {
          type: String,
          value: 'Sign out'
        },

        /**
         * If true, the button will be styled with a shadow.
         *
         * @attribute raised
         * @type boolean
         * @default false
         */
        raised: {
          type: Boolean,
          value: false
        },

        /**
         * The app activity types you want to write on behalf of the user
         * (e.g http://schemas.google.com/AddActivity)
         *
         * @attribute requestVisibleActions
         * @type string
         */
        requestVisibleActions: {
          type: String,
          value: ''
        },

        /**
         * The scopes to provide access to (e.g https://www.googleapis.com/auth/drive)
         * and should be space-delimited.
         *
         * @attribute scopes
         * @type string
         * @default 'profile'
         */
        scopes: {
          type: String,
          value: 'profile'
        },

        /**
         * The theme to use for the button.
         *
         * Available options: light, dark.
         *
         * @attribute theme
         * @type {ThemeValue}
         * @default 'dark'
         */
        theme: {
          type: String,
          value: 'dark'
        },

        /**
         * The width to use for the button.
         *
         * Available options: iconOnly, standard, wide.
         *
         * @attribute width
         * @type {WidthValue}
         * @default 'standard'
         */
        width: {
          type: String,
          value: 'standard'
        },
        /**
         * Is user signed in?
         *
         * @attribute signedIn
         * @type {Boolean}
         */
        signedIn: {
          type: Boolean,
          value: false,
          notify: true
        },
        /**
         * Is additional authorization required?
         * @attribute additionalAuth
         * @type {Boolean}
         */
        additionalAuth: {
          type: Boolean,
          value: false
        }
      },

      attached: function () {
        if (this.clientId === '') {
          throw 'A valid clientId is required to use this element';
        }

        // Determine the branding to use before the label.
        this.determineBranding();

        // Allow for the label to be provided as an attribute.
        if (this.labelSignin === '') {
          this.determineLabel();
        }

        if (defaultHandler === null) {
          // Bind the defaultHandler to the first attached signin button.
          defaultHandler = this;
        }
      },

      computeButtonClass: function(height, width, theme, signedIn, brand, additionalAuth) {
        return "height-" + height + " width-" + width + " theme-" + theme + " signedIn-" + signedIn + " brand-" + brand + "  additionalAuth-" + additionalAuth;
      },

      computeIcon: function(brand) {
        return "google:" + brand;
      },

      /* Button state computed */
      computeButtonIsSignIn: function(signedIn, additionalAuth) {
        return !signedIn;
      },
      computeButtonIsSignOut: function(signedIn, additionalAuth) {
        return signedIn && !additionalAuth;
      },
      computeButtonIsSignOutAddl: function(signedIn, additionalAuth) {
        return signedIn && additionalAuth;
      },
      /**
       * Adds additional extra scopes to be used when signing in.
       *
       * @param {Object} e Event triggering the request.
       * @param {Array} authScopes Scopes being requested.
       */
      authRequestScopes: function (e, authScopes) {
        // Only want the default handler to add the new scope for now.
        if (this !== defaultHandler) {
            return;
        }

        for (var i = 0; i < authScopes.length; i++) {
          if (authScopes[i] !== "") {
            authScopes[i] = authScopes[i].toLowerCase();

            if (extraScopes.indexOf(authScopes[i]) < 0) {
                extraScopes.push(authScopes[i]);
            }
          }
        }
      },

      /**
       * Handles a change to the authenticated user.
       */
      authUserChange: function(e, result) {
        this.signedIn = result.user.isSignedIn();

        if (this.signedIn) {
          this.checkScopes();

          // Trigger the google-signin-success event
          this.fire('google-signin-success', { 'user': result.user, 'gapi': gapi });
        } else {
          // Fire event to indicate user signed out
          this.fire('google-signed-out', { 'user': result.user });
        }
      },

      /**
       * Checks whether authorized and requested scopes match and
       * displays button for additional auth if necessary.
       *
       * @param {Array} scopes Scopes being requested.
       */
      checkScopes: function () {
        var currentScopes = this.scopes.split(' ');
        this.additionalAuth = false;

        for (var i = 0; i < currentScopes.length; i++) {
          if (currentScopes[i] !== '') {
            if (authorizedScopes.indexOf(currentScopes[i].toLowerCase()) < 0) {
              this.additionalAuth = true;
              this.fire('google-signin-necessary');
              break;
            }
          }
        }
      },

      /**
       * Determines the proper branding based on the scopes being requested.
       */
      determineBranding: function() {
        var scope;
        var currentScopes = this.scopes.split(' ');
        var hasPlusScopes = false;
        for (var i = 0; i < currentScopes.length; i++) {
          scope = currentScopes[i];
          if (scope == '') continue;
          if (scope.indexOf('/auth/games') > -1 || (
              scope.indexOf('auth/plus.') > -1 && scope.indexOf('auth/plus.me') < 0)) {
            hasPlusScopes = true;
          }
        }

        if (hasPlusScopes) {
          this.brand = BrandValue.PLUS;
        } else {
          this.brand = BrandValue.GOOGLE;
        }
      },

      /**
       * Determines the proper label based on the attributes.
       */
      determineLabel: function() {
        // If no label supplied use the width to determine label.
        if (this.width == WidthValue.WIDE) {
          if (this.brand == BrandValue.PLUS) {
              this.labelSignin = LabelValue.WIDE_PLUS;
          } else {
              this.labelSignin = LabelValue.WIDE;
          }
        } else if (this.width == WidthValue.STANDARD) {
          this.labelSignin = LabelValue.STANDARD;
        }
      },

      /**
       * Loads the `gapi.auth2` library and triggers the immediate auth.
       */
      loadAuth: function() {
        // Only the defaultHander should load the library.
        if (this !== defaultHandler) {
          return;
        }

        gapi.load('auth2', function() {
          var auth = gapi.auth2.init({
            'client_id': defaultHandler.clientId,
            'cookie_policy': defaultHandler.cookiePolicy,
            'scope': defaultHandler.scopes
          });
          // Listen for changes to the primary user.
          auth.currentUser.listen(function(newPrimary) {
            // Reset the authorized scopes and update with current user scopes.
            authorizedScopes = [];

            if (newPrimary.isSignedIn()) {
              var authResponse = newPrimary.getAuthResponse();

              // Store authorized scopes to check against for granted scopes.
              var tmpScopes = authResponse.scope.split(' ');
              for (var i = 0; i < tmpScopes.length; i++) {
                if (tmpScopes[i] !== "") {
                  authorizedScopes.push(tmpScopes[i].toLowerCase());

                  // Handle scopes that will be deprecated but are still returned with their old value
                  if (tmpScopes[i] === 'https://www.googleapis.com/auth/userinfo.profile') {
                    authorizedScopes.push('profile');
                  } else if (tmpScopes[i] === 'https://www.googleapis.com/auth/userinfo.email') {
                    authorizedScopes.push('email');
                  }
                }
              }
            }

            // Signal all buttons to update their state based on the user.
            defaultHandler.fire('core-signal', {
              'name': 'google-auth-user',
              'data': {
                'user': newPrimary
              }
            });
          });
        });
      },

      signIn: function () {
        var params = {
          'scope': mergeExtraScopes(this.scopes)
        };

        // // Proxy specific attributes through to the signIn options.
        Object.keys(ProxyLoginAttributes).forEach(function(key) {
          if (this[key] && this[key] !== '') {
            params[ProxyLoginAttributes[key]] = this[key];
          }
        }, this);
 
        gapi.auth2.getAuthInstance().signIn(params).then(function(newUser) {
          // Let the current user listener trigger the changes.
        }, function(error) {
          console.error(error);
        });
      },

      signInKeyPress: function (e) {
        if (e.which == 13 || e.keyCode == 13 || e.which == 32 || e.keyCode == 32) {
          e.preventDefault();
          this.signIn();
        }
      },

      signOut: function () {
        this.fire('google-signout-attempted');
        gapi.auth2.getAuthInstance().signOut().then(function() {
          // Let the current user listener trigger the changes.
        }, function(error) {
          console.error(error);
        });
      },

      signOutKeyPress: function (e) {
        if (e.which == 13 || e.keyCode == 13 || e.which == 32 || e.keyCode == 32) {
          e.preventDefault();
          this.signOut();
        }
      }
    });
  }());
</script>
